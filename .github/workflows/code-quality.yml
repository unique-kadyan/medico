name: Code Quality

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**/*.{js,jsx,ts,tsx}'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**/*.{js,jsx,ts,tsx}'

jobs:
  quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for full git history

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          npm run lint > eslint-report.txt 2>&1 || true
          cat eslint-report.txt
        continue-on-error: true

      - name: Run Prettier check
        id: prettier
        run: npm run format:check
        continue-on-error: true

      - name: Run tests
        id: tests
        run: npm test
        env:
          CI: true
        continue-on-error: true

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-results
          path: frontend/eslint-report.txt
          retention-days: 7

      - name: Create quality summary
        if: always()
        run: |
          echo "### Code Quality Summary :bar_chart:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint: ${{ steps.eslint.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Prettier: ${{ steps.prettier.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ steps.tests.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if quality checks failed
        if: steps.eslint.outcome != 'success' || steps.prettier.outcome != 'success'
        run: exit 1
